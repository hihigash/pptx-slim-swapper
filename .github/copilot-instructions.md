# PPTX Slim Swapper - Copilot Instructions

このプロジェクトは、PowerPointファイル(PPTX)内の画像や動画を一時的に外部保存し、プレースホルダーに置き換えることでファイルサイズを削減するコマンドラインツールです。

## プロジェクト概要

- **言語**: C# (.NET 8)
- **主要ライブラリ**:
  - `DocumentFormat.OpenXml` (3.2.0): PPTX ファイルの解析と編集
  - `System.CommandLine` (2.0.0-beta4): CLI インターフェース
  - `System.Drawing.Common` (9.0.9): 画像処理
- **アーキテクチャ**: シンプルな CLI アプリケーション

## プロジェクト構造

```
PptxSlimSwapper/
├── Models/              # データモデル
│   ├── MediaInfo.cs     # メディア情報
│   └── SwapManifest.cs  # 差し替えマニフェスト
├── Services/            # ビジネスロジック
│   ├── PlaceholderGenerator.cs  # プレースホルダー画像生成
│   └── PptxMediaSwapper.cs      # メディア差し替えエンジン
└── Program.cs           # エントリーポイント・CLI定義

PptxSlimSwapper.Tests/   # ユニットテストプロジェクト
```

## コーディング規約

### 一般的なルール

1. **命名規則**
   - クラス、メソッド、プロパティ: PascalCase
   - プライベートフィールド: camelCase
   - 定数: PascalCase
   - 日本語のXMLドキュメントコメントを付与する

2. **Null安全性**
   - `Nullable`は有効(enable)
   - null参照を避け、明示的なnullチェックを行う
   - null許容型には`?`を使用

3. **非同期処理**
   - I/O操作は必ず非同期メソッド(`async/await`)を使用
   - メソッド名は`Async`サフィックスを付ける

4. **エラーハンドリング**
   - ユーザーフレンドリーなエラーメッセージを表示
   - 適切な例外をスローし、キャッチする
   - ファイル操作のエラーは詳細に記録

### OpenXML SDK の使用

1. **ドキュメントの操作**
   - `using`ステートメントで確実にリソースを解放
   - `PresentationDocument.Open`で`isEditable`を適切に設定
   - 元のファイルは保持し、新しいファイルを生成

2. **パーツの取得**
   - スライド、スライドマスター、レイアウトスライドから包括的にメディアを収集
   - 重複を避けるため、URIでユニーク性を確保

3. **リレーションシップの管理**
   - メディアの置き換え時、既存のリレーションシップを削除してから新規作成
   - `ContentType`を正しく設定

### CLI開発

1. **コマンド設計**
   - `out`: メディアを外部保存してプレースホルダーに差し替え
   - `in`: プレースホルダーを元のメディアに復元
   - 明確な引数とオプションの説明

2. **ユーザーフィードバック**
   - 処理の進捗を適切に表示
   - 処理時間、ファイルサイズ削減率などの統計情報を表示
   - エラーは赤色で強調表示

3. **ファイルパス処理**
   - 絶対パスと相対パスの両方をサポート
   - デフォルト値は合理的な場所(カレントディレクトリ/output)

## 重要な実装パターン

### メディア差し替えフロー (SwapOut)

1. PPTXファイルをコピー
2. 全スライド・マスター・レイアウトからメディアを収集
3. 各メディアを外部ファイルとして保存
4. プレースホルダー画像を生成(メディア情報を埋め込み)
5. 元のメディアをプレースホルダーで置換
6. マニフェストファイル(JSON)を保存

### メディア復元フロー (SwapIn)

1. マニフェストファイルを読み込み
2. 差し替え済みPPTXファイルをコピー
3. プレースホルダーを検出し、マニフェストと照合
4. 元のメディアファイルで置換
5. 復元済みPPTXファイルを保存

### プレースホルダー画像

- 1x1ピクセルの小さなPNG画像
- ピクセルのRGB値にメディア情報をエンコード:
  - R: URIハッシュの上位8ビット
  - G: URIハッシュの下位8ビット
  - B: ContentTypeハッシュ
- これにより、復元時に正確なメディアを特定可能

## テストについて

- `PptxSlimSwapper.Tests`プロジェクトを使用
- ユニットテストを追加する際は、実際のPPTXファイルを使用したテストケースを含める
- テストデータは`data/`ディレクトリに配置

## コード変更時の注意点

1. **OpenXML SDKのバージョン**
   - 3.2.0 を使用しているため、API変更に注意
   - パッケージ更新時は互換性を確認

2. **ファイル操作**
   - 元のファイルを絶対に破壊しない
   - すべての出力ファイルには`_slim`や`_restored`のサフィックスを付ける

3. **マニフェストファイル**
   - JSON形式で保存し、人間が読める形式にフォーマット
   - `JsonSerializerOptions`で`WriteIndented = true`を使用

4. **エラーメッセージ**
   - 日本語で明確なメッセージを提供
   - ファイルパスやエラー詳細を含める

## 新機能追加時のガイドライン

1. **コマンド追加**
   - `Program.cs`に新しいコマンドメソッドを追加
   - 引数とオプションを明確に定義
   - ヘルプテキストを日本語で記述

2. **サービス拡張**
   - `Services/`ディレクトリに新しいサービスクラスを追加
   - 静的メソッドまたは依存性注入可能な設計
   - XMLドキュメントコメントを必ず追加

3. **モデル拡張**
   - `Models/`ディレクトリに新しいモデルを追加
   - JSONシリアライズ可能にする
   - プロパティには日本語のサマリーコメントを付ける

## よくある作業

### 新しいメディアタイプのサポート追加

1. `PptxMediaSwapper.cs`のメディア収集ロジックを拡張
2. 適切なContentTypeフィルタリングを追加
3. プレースホルダー生成ロジックを調整(必要に応じて)

### CLI オプション追加

1. `Program.cs`の該当コマンドに`Option`を追加
2. `SetHandler`の引数に追加
3. READMEを更新

### パフォーマンス改善

1. 大量のメディアファイル処理を並列化する場合は、`Parallel.ForEach`または`Task.WhenAll`を使用
2. メモリ効率を考慮し、ストリーム処理を優先
3. OpenXML SDKの推奨パターンに従う
